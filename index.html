<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AstroChat â€” Firebase</title>
<style>
  :root{--accent:#6b21a8;--muted:#6b7280}
  *{box-sizing:border-box}
  body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;background:#f6f4fb;color:#111}
  header{background:var(--accent);color:#fff;padding:12px;text-align:center;font-size:18px}
  .wrap{max-width:980px;margin:18px auto;padding:12px}
  .card{background:#fff;border-radius:10px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
  label{display:block;margin:8px 0 4px;font-weight:600}
  input[type=text], input[type=number], input[type=password]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6}
  button{padding:10px 14px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .muted{color:var(--muted);font-size:13px;margin-top:8px}
  .qr-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .qr{width:120px;height:120px;border-radius:8px;border:1px solid #eee}
  .icons img{width:36px;height:36px;margin-right:6px}
  .chat-box{height:320px;overflow:auto;padding:12px;border-radius:8px;background:#fafafa;border:1px solid #eee}
  .chat-row{display:flex;gap:8px;margin-top:8px}
  .chat-row input{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
  .small{font-size:14px;color:#333}
  .timer-row{display:flex;gap:12px;align-items:center;margin-top:8px}
  .pill{background:#f3f0fb;color:#4b0082;padding:6px 10px;border-radius:999px;font-weight:600}
  .balance-pill{background:#e6ffed;color:#064e3b;padding:6px 10px;border-radius:999px;font-weight:700}
  .message{display:block;clear:both;padding:8px 12px;margin:6px 0;border-radius:18px;max-width:75%;word-break:break-word}
  .msg-client{background:#fce7f3;float:left;border-bottom-left-radius:4px}
  .msg-astro{background:#dff7e6;float:right;border-bottom-right-radius:4px}
  .admin-panel{margin-top:8px}
  .tabs{display:flex;border-bottom:1px solid #eee;margin-bottom:8px}
  .tab{padding:10px 12px;cursor:pointer;color:#666;border-bottom:3px solid transparent}
  .tab.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:700}
  .row{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f6f6f8}
  .btn-ghost{background:#fff;color:var(--accent);border:1px solid var(--accent)}
  footer{padding:12px;text-align:center;color:#757575;font-size:13px}
  .hidden{display:none}
</style>
</head>
<body>
<header>ðŸŒŸ AstroChat â€” Firebase (Client + Admin)</header>
<div class="wrap">

  <!-- CLIENT CARD -->
  <section class="card">
    <h2>Recharge & Start Chat</h2>
    <div class="qr-row">
      <img id="qrImg" class="qr" alt="UPI QR"/>
      <div class="icons">
        <img src="https://img.icons8.com/color/48/google-pay.png" alt="GPay"/>
        <img src="https://img.icons8.com/color/48/bhim-upi.png" alt="UPI"/>
        <img src="https://img.icons8.com/color/48/phone-pe.png" alt="PhonePe"/>
      </div>
    </div>

    <div class="small">UPI ID: <strong>st227335-1@okicici</strong></div>

    <label>Amount (min â‚¹10)</label>
    <input id="payAmount" type="number" value="10" min="10"/>

    <label>UTR / Transaction ID</label>
    <input id="utrInput" type="text" placeholder="Enter UTR after payment"/>

    <div style="margin-top:10px">
      <button id="submitPaymentBtn">Submit Payment (for approval)</button>
    </div>
    <div id="pendingNotice" class="muted"></div>

    <hr style="margin:12px 0">

    <div id="walletInfo" class="small">Balance: â‚¹<span id="balance">0</span></div>
    <div id="statusMsg" class="muted">Wallet locked until admin approves payment.</div>

    <div class="timer-row" style="margin-top:12px">
      <div class="pill">Elapsed: <span id="elapsed">00:00</span></div>
      <div class="balance-pill">Remaining: â‚¹<span id="balDisp">0</span></div>
      <div style="margin-left:auto">
        <button id="startChatBtn" class="btn-ghost" disabled>Start Chat</button>
        <button id="stopChatBtn" disabled>Stop Chat</button>
      </div>
    </div>

    <div id="chatArea" style="margin-top:12px;display:none">
      <h3>Live Chat</h3>
      <div id="chatBox" class="chat-box"></div>
      <div class="chat-row" style="margin-top:8px">
        <input id="clientMsg" placeholder="Type your message..." />
        <button id="sendClientBtn">Send</button>
      </div>
      <div style="margin-top:8px"><button id="clearClientChat" class="btn-ghost">Clear Chat</button></div>
    </div>
  </section>

  <!-- ADMIN LOGIN + PANEL (PIN protected) -->
  <section class="card">
    <h2>Admin (Astrologer)</h2>
    <label>Enter PIN to unlock admin</label>
    <input id="adminPin" type="password" placeholder="Enter admin PIN"/>
    <div style="margin-top:8px">
      <button id="adminLoginBtn">Login</button>
      <span id="adminMsg" class="muted" style="margin-left:10px"></span>
    </div>

    <div id="adminPanel" class="admin-panel hidden">
      <div class="tabs">
        <div id="tabTx" class="tab active" onclick="showTab('tx')">Transactions</div>
        <div id="tabChat" class="tab" onclick="showTab('chat')">Chat</div>
      </div>

      <!-- Transactions view -->
      <div id="tabTransactions">
        <h3>Pending Transactions</h3>
        <div id="pendingList"></div>
      </div>

      <!-- Chat view -->
      <div id="tabChatView" class="hidden">
        <h3>Live Chat with Client</h3>
        <div id="adminChatBox" class="chat-box"></div>
        <div class="chat-row" style="margin-top:8px">
          <input id="adminMsgInput" placeholder="Type reply..." />
          <button id="sendAdminBtn">Send</button>
        </div>
      </div>
    </div>
  </section>

</div>
<footer>Â© AstroChat</footer>

<!-- Firebase SDKs (v12 modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  import {
    getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc,
    onSnapshot, query, where, orderBy, serverTimestamp, increment
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // ==== YOUR FIREBASE CONFIG (already provided by you) ====
  const firebaseConfig = {
    apiKey: "AIzaSyA_U-PINsJ6x1tZnzs6gWnhIuLCwwXjJOs",
    authDomain: "chattalk-3a35f.firebaseapp.com",
    projectId: "chattalk-3a35f",
    storageBucket: "chattalk-3a35f.firebasestorage.app",
    messagingSenderId: "776367142016",
    appId: "1:776367142016:web:aab3dd2d9fa3ebcd012265",
    measurementId: "G-SYWY2K8CVT"
  };

  const app = initializeApp(firebaseConfig);
  getAnalytics(app);
  const db = getFirestore(app);

  // ======= CONSTANTS =======
  const ADMIN_PIN = "2103";
  const PER_MIN = 10;
  const MIN_RECHARGE = 10;
  const WALLET_DOC = doc(db, "wallet", "primary");
  const CONTROL_DOC = doc(db, "control", "state"); // chat running state
  const MSGS_COL = collection(db, "messages");
  const TX_COL = collection(db, "transactions");

  // ======= UI ELEMENTS =======
  const balanceEl = document.getElementById('balance');
  const balDispEl = document.getElementById('balDisp');
  const pendingNoticeEl = document.getElementById('pendingNotice');
  const statusMsgEl = document.getElementById('statusMsg');
  const startBtn = document.getElementById('startChatBtn');
  const stopBtn = document.getElementById('stopChatBtn');
  const chatArea = document.getElementById('chatArea');
  const chatBox = document.getElementById('chatBox');
  const adminChatBox = document.getElementById('adminChatBox');
  const elapsedEl = document.getElementById('elapsed');
  const pendingList = document.getElementById('pendingList');
  const adminPanel = document.getElementById('adminPanel');

  // QR image
  document.getElementById('qrImg').src =
    'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' +
    encodeURIComponent('upi://pay?pa=st227335-1@okicici&pn=Shivam%20Tiwari&cu=INR');

  // ======= STATE =======
  let isAdmin = false;
  let seconds = 0;
  let timer = null;
  let chatRunning = false;
  let currentBalance = 0;

  // ======= HELPERS =======
  const formatTime = (s) => {
    const mm = String(Math.floor(s / 60)).padStart(2, '0');
    const ss = String(s % 60).padStart(2, '0');
    return mm + ':' + ss;
  };
  const setHidden = (el, hide) => el.classList.toggle('hidden', hide);

  // ======= LIVE LISTENERS =======
  // Wallet live
  onSnapshot(WALLET_DOC, (snap) => {
    if (snap.exists()) {
      const bal = Number(snap.data().balance || 0);
      currentBalance = bal;
      balanceEl.textContent = bal;
      balDispEl.textContent = bal;
      startBtn.disabled = bal < PER_MIN;
      if (bal < PER_MIN && chatRunning) {
        stopChatDueToLowBalance();
      }
    } else {
      // init wallet
      setDoc(WALLET_DOC, { balance: 0 });
    }
  });

  // Control live
  onSnapshot(CONTROL_DOC, (snap) => {
    if (snap.exists()) {
      const { running } = snap.data();
      chatRunning = !!running;
      startBtn.disabled = chatRunning || currentBalance < PER_MIN;
      stopBtn.disabled = !chatRunning;
      chatArea.style.display = chatRunning ? 'block' : 'none';
      statusMsgEl.textContent = chatRunning ? 'Chat is live.' : 'Wallet locked until admin approves payment.';
      if (!chatRunning) {
        if (timer) { clearInterval(timer); timer = null; seconds = 0; elapsedEl.textContent='00:00'; }
      } else {
        if (!timer) startLocalTimer();
      }
    } else {
      setDoc(CONTROL_DOC, { running: false });
    }
  });

  // Messages live
  const msgsQuery = query(MSGS_COL, orderBy('timestamp'));
  onSnapshot(msgsQuery, (snap) => {
    chatBox.innerHTML = '';
    adminChatBox.innerHTML = '';
    snap.forEach((docSnap) => {
      const m = docSnap.data();
      const node = document.createElement('div');
      node.className = 'message ' + (m.sender === 'client' ? 'msg-client' : m.sender === 'admin' ? 'msg-astro' : '');
      node.textContent = m.message;
      chatBox.appendChild(node);
      adminChatBox.appendChild(node.cloneNode(true));
    });
    chatBox.scrollTop = chatBox.scrollHeight;
    adminChatBox.scrollTop = adminChatBox.scrollHeight;
  });

  // Pending transactions live (admin only UI render)
  const renderPendingTx = () => {
    if (!isAdmin) { pendingList.innerHTML = '<div class="muted">Login as admin to see pending.</div>'; return; }
    const q = query(TX_COL, where('status', '==', 'pending'));
    onSnapshot(q, (snap) => {
      pendingList.innerHTML = '';
      if (snap.empty) {
        pendingList.innerHTML = '<div class="muted">No pending payments</div>';
      }
      snap.forEach((docSnap)=>{
        const tx = docSnap.data();
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = '<div><strong>â‚¹'+tx.amount+'</strong> &nbsp; UTR: '+(tx.utr||'')+'</div>';
        const right = document.createElement('div');
        const approve = document.createElement('button'); approve.textContent='Approve';
        approve.onclick = async ()=>{
          await updateDoc(docSnap.ref, { status: 'approved', approvedAt: serverTimestamp() });
          await updateDoc(WALLET_DOC, { balance: increment(Number(tx.amount||0)) });
          alert('Approved and credited â‚¹'+tx.amount);
        };
        const reject = document.createElement('button'); reject.textContent='Reject'; reject.style.marginLeft='8px';
        reject.onclick = async ()=>{
          const reason = prompt('Enter rejection reason') || 'Not verified';
          await updateDoc(docSnap.ref, { status: 'rejected', reason, rejectedAt: serverTimestamp() });
          alert('Rejected: '+reason);
        };
        right.appendChild(approve); right.appendChild(reject); row.appendChild(right);
        pendingList.appendChild(row);
      });
    });
  };

  // ======= CLIENT: submit payment =======
  document.getElementById('submitPaymentBtn').addEventListener('click', async ()=>{
    const amt = Number(document.getElementById('payAmount').value || 0);
    const utr = (document.getElementById('utrInput').value || '').trim();
    if (!utr) { alert('Enter UTR'); return; }
    if (isNaN(amt) || amt < MIN_RECHARGE) { alert('Minimum recharge â‚¹'+MIN_RECHARGE); return; }
    await addDoc(TX_COL, {
      utr, amount: amt, status: 'pending', createdAt: serverTimestamp()
    });
    pendingNoticeEl.textContent = 'Pending: â‚¹'+amt+' (UTR: '+utr+')';
    alert('Payment submitted. Admin will approve soon.');
    document.getElementById('utrInput').value='';
  });

  // ======= ADMIN LOGIN =======
  document.getElementById('adminLoginBtn').addEventListener('click', ()=>{
    const pin = document.getElementById('adminPin').value || '';
    if (pin === "2103") {
      isAdmin = true;
      document.getElementById('adminMsg').textContent = 'Login successful';
      adminPanel.classList.remove('hidden');
      renderPendingTx();
    } else {
      isAdmin = false;
      document.getElementById('adminMsg').textContent = 'Incorrect PIN';
      adminPanel.classList.add('hidden');
    }
  });

  // ======= CHAT SEND / RECEIVE =======
  document.getElementById('sendClientBtn').addEventListener('click', async ()=>{
    if (!chatRunning) { alert('Start chat to send messages'); return; }
    if (currentBalance < PER_MIN) { alert('Insufficient balance'); return; }
    const text = (document.getElementById('clientMsg').value || '').trim();
    if (!text) return;
    await addDoc(MSGS_COL, { sender:'client', message:text, timestamp: serverTimestamp() });
    document.getElementById('clientMsg').value='';
  });

  document.getElementById('sendAdminBtn').addEventListener('click', async ()=>{
    if (!isAdmin) { alert('Admin only'); return; }
    const text = (document.getElementById('adminMsgInput').value || '').trim();
    if (!text) return;
    await addDoc(MSGS_COL, { sender:'admin', message:text, timestamp: serverTimestamp() });
    document.getElementById('adminMsgInput').value='';
  });

  // ======= START/STOP CHAT + TIMER & DEDUCTION =======
  function startLocalTimer(){
    if (timer) clearInterval(timer);
    timer = setInterval(async ()=>{
      seconds++;
      elapsedEl.textContent = formatTime(seconds);
      // Every minute, deduct
      if (seconds % 60 === 0) {
        const balAfter = currentBalance - PER_MIN;
        if (balAfter >= 0) {
          await updateDoc(WALLET_DOC, { balance: increment(-PER_MIN) });
        }
      }
      // Auto-stop if balance falls below PER_MIN
      if (currentBalance < PER_MIN) {
        await stopChatDueToLowBalance();
      }
    }, 1000);
  }

  async function stopChatDueToLowBalance(){
    if (timer) { clearInterval(timer); timer = null; }
    seconds = 0;
    await setDoc(CONTROL_DOC, { running: false }, { merge: true });
    startBtn.disabled = true;
    stopBtn.disabled = true;
    chatArea.style.display = 'none';
    statusMsgEl.textContent = 'Balance finished. Please recharge to continue.';
    alert('Balance finished. Please recharge to continue.');
  }

  document.getElementById('startChatBtn').addEventListener('click', async ()=>{
    if (currentBalance < PER_MIN) { alert('Need at least â‚¹'+PER_MIN); return; }
    await setDoc(CONTROL_DOC, { running: true }, { merge: true });
    chatArea.style.display = 'block';
    startBtn.disabled = true; stopBtn.disabled = false;
  });

  document.getElementById('stopChatBtn').addEventListener('click', async ()=>{
    await setDoc(CONTROL_DOC, { running: false }, { merge: true });
    if (timer) { clearInterval(timer); timer = null; }
    seconds = 0;
    elapsedEl.textContent = '00:00';
    startBtn.disabled = currentBalance < PER_MIN ? true : false;
    stopBtn.disabled = true;
    chatArea.style.display = 'none';
  });

  // Tabs
  window.showTab = (t)=>{
    document.getElementById('tabTransactions').classList.toggle('hidden', t!=='tx');
    document.getElementById('tabChatView').classList.toggle('hidden', t!=='chat');
    document.getElementById('tabTx').classList.toggle('active', t==='tx');
    document.getElementById('tabChat').classList.toggle('active', t==='chat');
  };
</script>

</body>
</html>
